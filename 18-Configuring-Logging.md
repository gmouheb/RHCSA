# Configuring Logging in Linux

This document covers logging systems and their configuration in Linux environments.

## Introduction to Linux Logging

Logging is essential for system monitoring, troubleshooting, and security auditing. Linux provides several logging mechanisms:

- Traditional syslog
- Rsyslog (enhanced syslog)
- Syslog-ng (next-generation syslog)
- Journald (part of systemd)
- Application-specific logs

## Traditional Syslog System

The syslog protocol categorizes log messages by:
- Facility (the type of program generating the message)
- Severity (the importance of the message)

### Syslog Facilities

- `auth`/`authpriv`: Authentication and security
- `cron`: Cron daemon
- `daemon`: System daemons
- `kern`: Kernel messages
- `lpr`: Printing system
- `mail`: Mail system
- `news`: Network news subsystem
- `syslog`: Messages generated by syslogd
- `user`: User-level messages
- `local0` through `local7`: Local use

### Syslog Severity Levels

From highest to lowest priority:
1. `emerg`: System is unusable
2. `alert`: Action must be taken immediately
3. `crit`: Critical conditions
4. `err`: Error conditions
5. `warning`: Warning conditions
6. `notice`: Normal but significant conditions
7. `info`: Informational messages
8. `debug`: Debug-level messages

## Rsyslog Configuration

Rsyslog is the enhanced version of syslog and is the default logging system in many Linux distributions.

### Main Configuration File

The main configuration file is `/etc/rsyslog.conf`, with additional configuration files in `/etc/rsyslog.d/`.

### Basic Configuration Syntax

```
facility.severity    action
```

Examples:
```
# Log all kernel messages to the console
kern.*                                          /dev/console

# Log all messages of info level or higher to /var/log/messages
*.info                                          /var/log/messages

# Log all auth messages to /var/log/secure
auth,authpriv.*                                 /var/log/secure

# Log all mail messages to /var/log/maillog
mail.*                                          /var/log/maillog

# Log cron messages to /var/log/cron
cron.*                                          /var/log/cron
```

### Advanced Rsyslog Features

#### Templates

Templates define the format of log messages:

```
$template CustomFormat,"%TIMESTAMP% %HOSTNAME% %syslogtag% %msg%\n"
*.info                                          /var/log/custom.log;CustomFormat
```

#### Modules

Rsyslog uses modules to extend functionality:

```
# Load the imjournal module for systemd journal access
module(load="imjournal")

# Load the imudp module for UDP syslog reception
module(load="imudp")
input(type="imudp" port="514")
```

#### Filters

Filters allow more complex message selection:

```
# Filter messages containing "error" and log them to a special file
:msg, contains, "error"                         /var/log/errors.log
```

## Systemd Journal (Journald)

Journald is part of systemd and provides structured, indexed logging with powerful query capabilities.

### Viewing Journal Logs

```bash
# View all journal entries
journalctl

# View journal entries for a specific service
journalctl -u service_name

# View journal entries since last boot
journalctl -b

# View journal entries for a specific time period
journalctl --since="2023-01-01" --until="2023-01-02"

# View journal entries by priority
journalctl -p err

# View journal entries for a specific process
journalctl _PID=1234

# View journal entries for a specific executable
journalctl /usr/bin/program_name
```

### Persistent Journal Storage

By default, journal logs may be stored only in memory or with limited persistence. To enable persistent storage:

1. Create the journal directory:
```bash
mkdir -p /var/log/journal
```

2. Set appropriate permissions:
```bash
systemd-tmpfiles --create --prefix /var/log/journal
```

3. Restart the journal service:
```bash
systemctl restart systemd-journald
```

### Journal Configuration

The main configuration file is `/etc/systemd/journald.conf`:

```ini
[Journal]
# Store journal on disk
Storage=persistent

# Control log size
SystemMaxUse=1G
SystemKeepFree=1G

# Maximum file size
SystemMaxFileSize=100M

# Compression
Compress=yes

# Maximum retention time
MaxRetentionSec=1month
```

## Logrotate - Managing Log Files

Logrotate handles automatic rotation, compression, and removal of log files.

### Configuration Files

- Main configuration: `/etc/logrotate.conf`
- Additional configurations: `/etc/logrotate.d/`

### Basic Configuration Example

```
/var/log/messages {
    weekly
    rotate 4
    missingok
    notifempty
    compress
    delaycompress
    sharedscripts
    postrotate
        /usr/bin/systemctl reload rsyslog.service > /dev/null 2>&1 || true
    endscript
}
```

### Common Options

- `daily`, `weekly`, `monthly`: Rotation frequency
- `rotate n`: Keep n rotated logs before removing
- `size size`: Rotate when log reaches specified size
- `compress`: Compress rotated logs
- `missingok`: Don't error if log file is missing
- `notifempty`: Don't rotate empty files
- `create mode owner group`: Create new log file with specified permissions
- `postrotate`/`endscript`: Commands to run after rotation

## Remote Logging

### Configuring a Syslog Server (Rsyslog)

1. Edit `/etc/rsyslog.conf` on the server:
```
# Load UDP module
module(load="imudp")
input(type="imudp" port="514")

# Load TCP module
module(load="imtcp")
input(type="imtcp" port="514")

# Create a template for remote hosts
$template RemoteHost,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
*.* ?RemoteHost
```

2. Create the log directory:
```bash
mkdir -p /var/log/remote
```

3. Restart rsyslog:
```bash
systemctl restart rsyslog
```

### Configuring a Syslog Client (Rsyslog)

Edit `/etc/rsyslog.conf` on the client:
```
# Send all logs to remote server
*.* @server_ip:514     # UDP
*.* @@server_ip:514    # TCP
```

## Application-Specific Logging

Many applications maintain their own log files:

- Apache: `/var/log/httpd/` or `/var/log/apache2/`
- Nginx: `/var/log/nginx/`
- MySQL/MariaDB: `/var/log/mysql/` or `/var/log/mariadb/`
- PostgreSQL: `/var/log/postgresql/`
- Mail logs: `/var/log/maillog` or `/var/log/mail.log`

## Log Analysis Tools

### Basic Tools

```bash
# Search logs for specific terms
grep "error" /var/log/messages

# Display the last 100 lines of a log file
tail -n 100 /var/log/messages

# Follow log updates in real-time
tail -f /var/log/messages

# Count occurrences of a pattern
grep -c "error" /var/log/messages
```

### Advanced Tools

- `logwatch`: Analyzes logs and sends reports
- `fail2ban`: Monitors logs for suspicious activity and blocks offending IP addresses
- `logcheck`: Scans log files for suspicious entries
- `ELK Stack` (Elasticsearch, Logstash, Kibana): Advanced log collection, processing, and visualization

## Security Considerations

### Log File Permissions

```bash
# Set appropriate permissions on log files
chmod 640 /var/log/messages
chown root:adm /var/log/messages
```

### Log Integrity

Consider using tools like `logrotate` with the `create` option to ensure proper permissions on new log files.

### Log Monitoring

Set up automated monitoring of logs for security events:

```bash
# Install auditd for advanced security logging
dnf install audit

# Configure audit rules
auditctl -w /etc/passwd -p wa -k user-modification
```

## Best Practices

1. Centralize logs when managing multiple systems
2. Implement log rotation to manage disk space
3. Set appropriate retention periods based on compliance requirements
4. Monitor logs regularly for errors and security issues
5. Secure log files with appropriate permissions
6. Configure remote logging for critical systems
7. Use structured logging where possible
8. Implement automated log analysis
9. Document your logging configuration
10. Test log rotation and archiving procedures regularly